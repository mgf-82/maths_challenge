<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Super Maths Challenge 4.0</title>
  <meta name="color-scheme" content="dark light">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* CORE THEME */
      --font-stack: 'Fredoka', system-ui, sans-serif;
      
      --bg-dark: #121629;
      --panel-dark: #1c223f;
      --border-dark: #2f3863;
      
      --bg-light: #f0f4f8;
      --panel-light: #ffffff;
      --border-light: #dbe2e8;

      /* GAME COLORS */
      --primary: #4e8cff;
      --success: #00d26a;
      --danger: #ff5d6c;
      --warning: #ffcd38;
      --purple: #a78bfa;
      
      /* LEVELS */
      --lvl1: #00d26a; /* Green */
      --lvl2: #4e8cff; /* Blue */
      --lvl3: #a78bfa; /* Purple */
      --lvl4: #ff5d6c; /* Red */
      
      /* DEFAULT (DARK) */
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --text: #eef2ff;
      --muted: #8b9bb4;
      --border: var(--border-dark);
      
      --radius-md: 20px;
    }

    [data-theme='light'] {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --text: #2d3436;
      --muted: #636e72;
      --border: var(--border-light);
    }
    
    .bg-particles {
      position: fixed; inset: 0; pointer-events: none; z-index: -1;
      overflow: hidden;
      background: radial-gradient(circle at 50% -20%, #2a3359 0%, var(--bg) 80%);
    }
    [data-theme='light'] .bg-particles {
      background: radial-gradient(circle at 50% -20%, #eef2ff 0%, var(--bg) 80%);
    }
    .particle {
      position: absolute; border-radius: 50%; opacity: 0.1;
      animation: floatUp 20s linear infinite; background: currentColor; color: var(--text);
    }
    .particle:nth-child(1) { left: 10%; width: 40px; height: 40px; animation-duration: 25s; }
    .particle:nth-child(2) { left: 80%; width: 60px; height: 60px; animation-duration: 30s; }
    .particle:nth-child(3) { left: 40%; width: 20px; height: 20px; animation-duration: 15s; }

    @keyframes floatUp {
      0% { transform: translateY(110vh) rotate(0deg); }
      100% { transform: translateY(-10vh) rotate(360deg); }
    }

    /* BASE STYLES */
    *, *::before, *::after { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    html, body { height: 100%; margin: 0; }
    
    body {
      font-family: var(--font-stack);
      background-color: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 16px;
      overflow: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app {
      width: min(800px, 100%);
      height: min(900px, 98vh);
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s;
    }

    /* HEADER */
    header {
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px dashed var(--border);
      background: rgba(0,0,0,0.02);
    }
    .hud-left, .hud-right { display: flex; gap: 8px; align-items: center; }

    .pill {
      background: var(--bg);
      border: 2px solid var(--border);
      padding: 4px 12px;
      border-radius: 99px;
      font-weight: 700;
      font-size: 14px;
      display: flex; align-items: center; gap: 6px;
    }
    .pill.score { color: var(--success); border-color: rgba(0, 210, 106, 0.3); }
    .pill.timer { color: var(--danger); border-color: rgba(255, 93, 108, 0.3); }

    .multiplier-badge {
      background: linear-gradient(135deg, #ffcd38, #ff9f43);
      color: #fff;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 900;
      font-size: 14px;
      transform: scale(0);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-shadow: 0 2px 0 rgba(0,0,0,0.2);
    }
    .multiplier-badge.visible { transform: scale(1); animation: pulse 1s infinite; }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 10px;
      position: relative;
    }

    .xp-container { width: 100%; padding: 0 10px; }
    .progress-track {
      height: 12px; background: var(--bg); border-radius: 99px; overflow: hidden; border: 1px solid var(--border);
    }
    .progress-fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--purple));
      transition: width 0.5s ease;
    }

    .question-card {
      flex: 1;
      background: radial-gradient(circle at center, rgba(255,255,255,0.03), transparent);
      border-radius: var(--radius-md);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      position: relative;
    }

    .mascot {
      font-size: 80px;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2));
      transition: transform 0.2s;
      cursor: pointer;
    }
    .mascot.jump { animation: mascotJump 0.4s ease; }
    .mascot.shake { animation: mascotShake 0.4s ease; }
    
    @keyframes mascotJump { 0%{transform:scaleY(1) translateY(0)} 50%{transform:scaleY(0.8) translateY(20px)} 70%{transform:scaleY(1.2) translateY(-40px)} 100%{transform:scaleY(1) translateY(0)} }
    @keyframes mascotShake { 0%{transform:translateX(0)} 25%{transform:translateX(-15px) rotate(-10deg)} 75%{transform:translateX(15px) rotate(10deg)} 100%{transform:translateX(0)} }

    .question-text {
      font-size: clamp(40px, 10vw, 80px);
      font-weight: 700; margin: 20px 0;
      text-shadow: 4px 4px 0 rgba(0,0,0,0.1);
      line-height: 1.1; text-align: center;
    }

    .answers-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: auto;
    }
    button.answer-btn {
      background: var(--panel);
      border: 2px solid var(--border); border-bottom-width: 6px;
      color: var(--text);
      font-family: var(--font-stack); font-size: 32px; font-weight: 700;
      padding: 24px; border-radius: 16px;
      cursor: pointer; transition: all 0.1s; position: relative; overflow: hidden;
    }
    button.answer-btn:hover { transform: translateY(-2px); border-bottom-width: 8px; border-color: var(--primary); }
    button.answer-btn:active { transform: translateY(4px); border-bottom-width: 2px; }
    
    button.answer-btn.correct { background: var(--success); color: white; border-color: #00b059; }
    button.answer-btn.wrong { background: var(--danger); color: white; border-color: #d1414e; }

    .effects-layer { position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 10; }
    
    .float-text {
      position: absolute; font-weight: 900; font-size: 24px;
      animation: floatFade 1s forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    @keyframes floatFade { 0%{transform:translate(-50%, 0) scale(0.5); opacity:0;} 20%{transform:translate(-50%, -20px) scale(1.2); opacity:1;} 100%{transform:translate(-50%, -80px) scale(1); opacity:0;} }

    .confetti { position: absolute; width: 10px; height: 10px; border-radius: 4px; animation: confettiFall 1s forwards; }
    @keyframes confettiFall { 0%{transform:translate(0,0) rotate(0);} 100%{transform:translate(var(--vx), var(--vy)) rotate(720deg); opacity: 0;} }

    .flash-overlay {
      position: absolute; inset: 0; pointer-events: none; opacity: 0; z-index: 20; transition: opacity 0.2s;
    }
    .flash-overlay.green { background: rgba(0, 210, 106, 0.2); }
    .flash-overlay.red { background: rgba(255, 93, 108, 0.2); }

    /* MENU STYLES */
    .overlay-screen {
      position: absolute; inset: 0; background: var(--bg); z-index: 50;
      display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
      transition: transform 0.4s ease;
    }
    .overlay-screen.hidden { transform: translateY(-100%); pointer-events: none; }
    
    .screen-content { max-width: 700px; margin: 0 auto; width: 100%; text-align: center; }

    h3 { margin-bottom: 12px; margin-top: 24px; color: var(--primary); text-transform: uppercase; font-size: 14px; letter-spacing: 1px; font-weight: 800; }

    .avatar-grid { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .avatar-option {
      font-size: 36px; width: 60px; height: 60px; display: grid; place-items: center;
      background: var(--panel); border: 2px solid var(--border); border-radius: 50%;
      cursor: pointer; transition: 0.2s;
    }
    .avatar-option.selected { background: var(--primary); border-color: var(--primary); transform: scale(1.15); }

    /* LEVEL TABS */
    .level-tabs {
      display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; flex-wrap: wrap;
    }
    .lvl-tab {
      background: var(--panel); border: 2px solid var(--border);
      padding: 8px 16px; border-radius: 12px; font-weight: 700; cursor: pointer;
      font-size: 14px; opacity: 0.6; transition: 0.2s;
      flex: 1; min-width: 80px; max-width: 140px;
    }
    .lvl-tab:hover { opacity: 0.8; transform: translateY(-2px); }
    .lvl-tab.active { opacity: 1; color: white; border-color: transparent; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    
    .lvl-tab[data-lvl="1"].active { background: var(--lvl1); }
    .lvl-tab[data-lvl="2"].active { background: var(--lvl2); }
    .lvl-tab[data-lvl="3"].active { background: var(--lvl3); }
    .lvl-tab[data-lvl="4"].active { background: var(--lvl4); }

    .mission-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 10px;
    }
    .mission-card {
      background: var(--panel); border: 2px solid var(--border); border-radius: 16px; padding: 16px 10px;
      cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 8px; aspect-ratio: 1.1; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative;
    }
    .mission-card.hidden { display: none; }
    .mission-card:hover { transform: translateY(-3px); border-color: var(--muted); }
    
    /* Active States per level */
    .mission-card.selected { background: rgba(255,255,255,0.05); box-shadow: 0 0 0 2px currentColor inset; }
    
    [data-lvl-active="1"] .mission-card.selected { border-color: var(--lvl1); color: var(--lvl1); }
    [data-lvl-active="2"] .mission-card.selected { border-color: var(--lvl2); color: var(--lvl2); }
    [data-lvl-active="3"] .mission-card.selected { border-color: var(--lvl3); color: var(--lvl3); }
    [data-lvl-active="4"] .mission-card.selected { border-color: var(--lvl4); color: var(--lvl4); }

    .mission-icon { font-size: 32px; display: block; line-height: 1; }
    .mission-title { font-size: 15px; font-weight: 700; color: var(--text); }
    .high-score-label {
      font-size: 11px; color: var(--muted); font-weight: 700; background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 10px; white-space: nowrap;
    }
    [data-theme='dark'] .high-score-label { background: rgba(255,255,255,0.05); }

    .time-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .time-btn {
      background: var(--panel); border: 2px solid var(--border); padding: 8px 16px;
      border-radius: 99px; font-weight: 700; color: var(--muted); cursor: pointer; transition: 0.2s; font-family: var(--font-stack);
    }
    .time-btn:hover { border-color: var(--primary); }
    .time-btn.selected { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

    /* BUTTONS */
    .btn-lg {
      background: var(--primary); color: white; font-family: var(--font-stack); font-size: 24px; font-weight: 700;
      padding: 16px 50px; border: none; border-radius: 99px; cursor: pointer;
      box-shadow: 0 8px 20px rgba(78, 140, 255, 0.4); transition: transform 0.1s; margin-top: 10px; width: 100%; max-width: 280px;
    }
    .btn-lg:hover { transform: scale(1.05); }
    .btn-lg:active { transform: scale(0.95); }

    .btn-secondary {
      background: transparent; color: var(--text); font-family: var(--font-stack); font-size: 18px; font-weight: 600;
      padding: 12px 30px; border: 2px solid var(--border); border-radius: 99px; cursor: pointer;
      margin-top: 10px; width: 100%; max-width: 280px; transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }

    .modal-backdrop {
      position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: grid; place-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }
    .result-sheet {
      background: var(--panel); width: 90%; max-width: 350px; padding: 30px; border-radius: var(--radius-md); text-align: center;
      display: flex; flex-direction: column; align-items: center;
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from{transform:scale(0.5)} to{transform:scale(1)} }

    /* COUNTDOWN OVERLAY */
    .countdown-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 60;
      display: grid; place-items: center;
      font-size: 140px; font-weight: 900; color: white;
      pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    .countdown-overlay.active { opacity: 1; pointer-events: auto; }
    .countdown-num { animation: popScale 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popScale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

    @media (max-width: 600px) {
      .answers-grid { grid-template-columns: 1fr; }
      .question-text { font-size: 50px; }
      .level-tabs { gap: 4px; }
      .lvl-tab { padding: 6px 10px; font-size: 12px; }
    }
  </style>
</head>
<body data-theme="dark">

  <div class="bg-particles">
    <div class="particle">‚óè</div><div class="particle">‚ñ†</div><div class="particle">‚ñ≤</div>
  </div>

  <div class="app" id="app">
    
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="effects-layer" id="effectsLayer"></div>
    <div class="countdown-overlay" id="countdownOverlay"></div>

    <header>
      <div class="hud-left">
        <button id="exitBtn" style="background:none; border:none; font-size:20px; cursor:pointer;" title="Exit to Menu">üè†</button>
        <div class="pill score">‚≠ê <span id="scoreDisplay">0</span></div>
        <div class="multiplier-badge" id="multBadge">x2 COMBO!</div>
      </div>
      <div class="hud-right">
        <div class="pill timer">‚è∞ <span id="timerDisplay">02:00</span></div>
        <button id="soundBtn" style="background:none; border:none; font-size:20px; cursor:pointer;">üîä</button>
      </div>
    </header>

    <main>
      <div class="xp-container">
        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700; color:var(--muted); margin-bottom:4px;">
          <span id="rankTitle">Novice</span>
          <span id="streakDisplay">Streak: 0</span>
        </div>
        <div class="progress-track"><div class="progress-fill" id="xpBar"></div></div>
      </div>

      <div class="question-card">
        <div class="mascot" id="mascot">üêº</div>
        <div class="question-text" id="qText">Ready?</div>
      </div>

      <div class="answers-grid" id="answersArea"></div>
    </main>

    <div class="overlay-screen" id="welcomeScreen">
      <div class="screen-content">
        <h1 style="color:var(--primary); margin-top:20px;">Super Maths 4.0</h1>
        <p style="color:var(--muted)">Use Mouse or Keyboard (1-4)</p>

        <h3>1. Pick Hero</h3>
        <div class="avatar-grid" id="avatarSelector">
          <div class="avatar-option selected">üêº</div>
          <div class="avatar-option">ü¶Å</div>
          <div class="avatar-option">üê∏</div>
          <div class="avatar-option">ü¶Ñ</div>
          <div class="avatar-option">ü§ñ</div>
          <div class="avatar-option">üëΩ</div>
        </div>

        <h3>2. Pick Mission</h3>
        
        <div class="level-tabs" id="levelTabs">
          <div class="lvl-tab active" data-lvl="1">Mini</div>
          <div class="lvl-tab" data-lvl="2">Junior</div>
          <div class="lvl-tab" data-lvl="3">Senior</div>
          <div class="lvl-tab" data-lvl="4">High School</div>
        </div>

        <div class="mission-grid" id="missionSelector" data-lvl-active="1">
          
          <div class="mission-card selected" data-level="1" data-mode="l1_add">
            <span class="mission-icon">üê£</span><span class="mission-title">Sum to 10</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="1" data-mode="l1_sub">
            <span class="mission-icon">‚ûñ</span><span class="mission-title">Take Away 10</span><span class="high-score-label">Best: 0</span>
          </div>

          <div class="mission-card" data-level="2" data-mode="l2_add">
            <span class="mission-icon">‚ûï</span><span class="mission-title">Double Digits</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="2" data-mode="l2_sub">
            <span class="mission-icon">‚ûñ</span><span class="mission-title">Subtraction</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="2" data-mode="l2_mul">
            <span class="mission-icon">‚úñ</span><span class="mission-title">Times Tables</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="2" data-mode="l2_place">
            <span class="mission-icon">üî¢</span><span class="mission-title">Place Value</span><span class="high-score-label">Best: 0</span>
          </div>

          <div class="mission-card" data-level="3" data-mode="l3_add">
            <span class="mission-icon">‚ûï</span><span class="mission-title">3-Digit Add</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_sub">
            <span class="mission-icon">‚ûñ</span><span class="mission-title">3-Digit Sub</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_mul">
            <span class="mission-icon">‚úñ</span><span class="mission-title">Big Multiply</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_div">
            <span class="mission-icon">‚ûó</span><span class="mission-title">Division</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_power">
            <span class="mission-icon">‚ö°</span><span class="mission-title">Powers</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_root">
            <span class="mission-icon">üå±</span><span class="mission-title">Roots</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="3" data-mode="l3_alg">
            <span class="mission-icon">üß©</span><span class="mission-title">Algebra I</span><span class="high-score-label">Best: 0</span>
          </div>

          <div class="mission-card" data-level="4" data-mode="l4_int">
            <span class="mission-icon">‚ùÑÔ∏è</span><span class="mission-title">Integers</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="4" data-mode="l4_bod">
            <span class="mission-icon">üèóÔ∏è</span><span class="mission-title">BODMAS</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="4" data-mode="l4_pct">
            <span class="mission-icon">üíØ</span><span class="mission-title">Percentage</span><span class="high-score-label">Best: 0</span>
          </div>
          <div class="mission-card" data-level="4" data-mode="l4_alg">
            <span class="mission-icon">üß†</span><span class="mission-title">Algebra II</span><span class="high-score-label">Best: 0</span>
          </div>

        </div>

        <h3>3. Mission Time</h3>
        <div class="time-selector">
          <button class="time-btn" data-time="1">1 Min</button>
          <button class="time-btn selected" data-time="2">2 Mins</button>
          <button class="time-btn" data-time="5">5 Mins</button>
        </div>
        
        <button class="btn-lg" id="startBtn">START MISSION ‚ñ∂</button>
        
        <div style="margin-top:20px;">
           <label style="font-size:14px; color:var(--muted); cursor:pointer;">
             <input type="checkbox" id="themeToggle"> Light Mode ‚òÄÔ∏è
           </label>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="resultModal">
      <div class="result-sheet">
        <div style="font-size:60px;">üèÜ</div>
        <h2>Time's Up!</h2>
        <div style="font-size:50px; font-weight:900; color:var(--primary)" id="finalScore">0</div>
        <p style="color:var(--muted); margin-bottom:20px;" id="newRecordMsg"></p>
        
        <button class="btn-lg" id="playAgainBtn">AGAIN ‚Ü∫</button>
        <button class="btn-secondary" id="homeBtn">HOME üè†</button>
      </div>
    </div>

  </div>

  <script>
    /* ================= GAME ENGINE 4.0 ================= */
    (function(){
      // -- STATE & CONFIG --
      const S = {
        active: false,
        timeLimit: 2, 
        endTime: 0,
        score: 0,
        streak: 0,
        mode: 'l1_add', // Default
        currentLevel: 1,
        avatar: 'üêº',
        sound: true,
        multiplier: 1,
        highScores: JSON.parse(localStorage.getItem('superMathsScoresV4')) || {},
        rankTitle: 'Novice',
        rankScore: 0
      };

      const RANKS = [
        { min:0, title:"Novice" }, { min:10, title:"Apprentice" }, { min:30, title:"Math Ninja" },
        { min:60, title:"Professor" }, { min:120, title:"LEGEND" }, { min:200, title:"GODLIKE" }
      ];

      // -- DOM CACHE --
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);
      
      const el = {
        app: $('#app'),
        startScreen: $('#welcomeScreen'),
        resultModal: $('#resultModal'),
        timer: $('#timerDisplay'),
        score: $('#scoreDisplay'),
        streak: $('#streakDisplay'),
        xp: $('#xpBar'),
        rank: $('#rankTitle'),
        qText: $('#qText'),
        mascot: $('#mascot'),
        answers: $('#answersArea'),
        multBadge: $('#multBadge'),
        effects: $('#effectsLayer'),
        flash: $('#flashOverlay'),
        missionCards: $$('.mission-card'),
        lvlTabs: $$('.lvl-tab'),
        timeBtns: $$('.time-btn'),
        countdown: $('#countdownOverlay'),
        missionGrid: $('#missionSelector')
      };

      // -- AUDIO ENGINE --
      const AudioSys = {
        ctx: null,
        init: function(){
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if(!this.ctx) this.ctx = new Ctx();
          if(this.ctx.state === 'suspended') this.ctx.resume();
        },
        playTone: function(freq, type, dur, vol=0.1, delay=0){
          if(!S.sound || !this.ctx) return;
          const t = this.ctx.currentTime + delay;
          const osc = this.ctx.createOscillator();
          const g = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, t);
          g.gain.setValueAtTime(vol, t);
          g.gain.exponentialRampToValueAtTime(0.01, t + dur);
          osc.connect(g); g.connect(this.ctx.destination);
          osc.start(t); osc.stop(t + dur);
        },
        playCorrect: function(combo){
          const base = 523.25; 
          const pitchMod = Math.min(1.5, 1 + (combo*0.1)); 
          this.playTone(base * pitchMod, 'sine', 0.3, 0.1, 0);
          this.playTone(base * 1.25 * pitchMod, 'sine', 0.3, 0.1, 0.05); 
          this.playTone(base * 1.5 * pitchMod, 'sine', 0.4, 0.1, 0.1);  
        },
        playWrong: function(){
          this.playTone(150, 'sawtooth', 0.4, 0.2, 0);
          this.playTone(142, 'sawtooth', 0.4, 0.2, 0.05);
        },
        playLevelUp: function(){
          [523, 659, 783, 1046].forEach((f, i) => this.playTone(f, 'square', 0.2, 0.05, i*0.08));
        }
      };

      // -- EFFECTS --
      function spawnConfetti(x, y, color='#fff') {
        for(let i=0; i<15; i++){
          const p = document.createElement('div');
          p.className = 'confetti';
          p.style.left = x + 'px'; p.style.top = y + 'px'; p.style.background = color;
          const vx = (Math.random() - 0.5) * 200 + 'px';
          const vy = (Math.random() * 200 + 50) + 'px';
          p.style.setProperty('--vx', vx); p.style.setProperty('--vy', vy);
          el.effects.appendChild(p);
          setTimeout(()=>p.remove(), 1000);
        }
      }

      function showFloatingText(x, y, text, color) {
        const ft = document.createElement('div');
        ft.className = 'float-text';
        ft.textContent = text;
        ft.style.left = x + 'px'; ft.style.top = y + 'px'; ft.style.color = color;
        el.effects.appendChild(ft);
        setTimeout(()=>ft.remove(), 1000);
      }

      function flashScreen(type){
        el.flash.className = `flash-overlay ${type}`;
        el.flash.style.opacity = '1';
        setTimeout(() => el.flash.style.opacity = '0', 200);
      }

      // -- LOGIC --
      function updateHighScoresDisplay(){
        el.missionCards.forEach(card => {
           const m = card.dataset.mode;
           const label = card.querySelector('.high-score-label');
           const sc = S.highScores[m] || 0;
           if(label) label.textContent = `Best: ${sc}`;
        });
      }

      function filterMissions(lvl){
        S.currentLevel = parseInt(lvl);
        el.lvlTabs.forEach(t => {
            if(parseInt(t.dataset.lvl) === S.currentLevel) t.classList.add('active');
            else t.classList.remove('active');
        });

        // Show/Hide cards
        el.missionCards.forEach(card => {
            if(parseInt(card.dataset.level) === S.currentLevel) card.classList.remove('hidden');
            else card.classList.add('hidden');
        });

        // Auto-select first visible
        const first = Array.from(el.missionCards).find(c => parseInt(c.dataset.level) === S.currentLevel);
        if(first) first.click();
        
        el.missionGrid.dataset.lvlActive = S.currentLevel;
      }

      function updateHUD(){
        const rem = Math.max(0, S.endTime - Date.now());
        const m = Math.floor(rem/60000);
        const s = Math.floor((rem%60000)/1000);
        el.timer.textContent = `${m}:${s.toString().padStart(2,'0')}`;
        if(rem <= 0 && S.active) endGame();

        el.score.textContent = S.score;
        el.streak.textContent = `Streak: ${S.streak} üî•`;

        if(S.streak >= 10) S.multiplier = 3;
        else if(S.streak >= 5) S.multiplier = 2;
        else S.multiplier = 1;

        if(S.multiplier > 1){
          el.multBadge.textContent = `x${S.multiplier} COMBO!`;
          el.multBadge.classList.add('visible');
        } else {
          el.multBadge.classList.remove('visible');
        }

        let r = RANKS[0];
        RANKS.forEach(rank => { if(S.rankScore >= rank.min) r = rank; });
        if(r.title !== S.rankTitle){
           S.rankTitle = r.title;
           el.rank.textContent = r.title;
           AudioSys.playLevelUp();
           showFloatingText(window.innerWidth/2, window.innerHeight/2, `${r.title}!`, '#ffcd38');
        }

        const currentCap = RANKS.find(rx => rx.min > S.rankScore)?.min || 200;
        const prevCap = RANKS.slice().reverse().find(rx => rx.min <= S.rankScore)?.min || 0;
        const pct = ((S.rankScore - prevCap) / (currentCap - prevCap)) * 100;
        el.xp.style.width = Math.min(100, Math.max(5, pct)) + '%';
      }

      function startCountdown() {
        AudioSys.init();
        el.startScreen.classList.add('hidden');
        el.resultModal.classList.remove('show');
        el.countdown.classList.add('active');
        
        let count = 3;
        function tick() {
          if (count > 0) {
            el.countdown.innerHTML = `<div class="countdown-num">${count}</div>`;
            AudioSys.playTone(600 + (3-count)*100, 'triangle', 0.15); 
            count--;
            setTimeout(tick, 1000);
          } else {
            el.countdown.innerHTML = `<div class="countdown-num" style="color:var(--success)">GO!</div>`;
            AudioSys.playTone(1000, 'square', 0.3);
            setTimeout(() => {
              el.countdown.classList.remove('active');
              el.countdown.innerHTML = '';
              startGame(); 
            }, 500);
          }
        }
        tick();
      }

      function startGame(){
        S.active = true;
        S.score = 0;
        S.streak = 0;
        S.multiplier = 1;
        S.rankScore = 0;
        S.endTime = Date.now() + (S.timeLimit * 60 * 1000);
        
        el.mascot.textContent = S.avatar;
        updateHUD();
        nextQuestion();
        gameLoop();
      }

      function gameLoop(){
        if(!S.active) return;
        updateHUD();
        requestAnimationFrame(gameLoop);
      }

      function endGame(){
        S.active = false;
        el.resultModal.classList.add('show');
        $('#finalScore').textContent = S.score;
        
        const oldBest = S.highScores[S.mode] || 0;
        if(S.score > oldBest){
          S.highScores[S.mode] = S.score;
          localStorage.setItem('superMathsScoresV4', JSON.stringify(S.highScores));
          $('#newRecordMsg').textContent = "üéâ NEW RECORD! üéâ";
          AudioSys.playLevelUp();
        } else {
          $('#newRecordMsg').textContent = `Best: ${oldBest}`;
        }
        updateHighScoresDisplay();
      }

      // -- MATHS GENERATOR V4 --
      function generateQ(){
        const r = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
        let q = "", a = 0;

        switch(S.mode) {
          /* LEVEL 1: MINI */
          case 'l1_add': { const t=r(2,10); const p1=r(1,t-1); q=`${p1} + ${t-p1}`; a=t; break; }
          case 'l1_sub': { const x=r(2,10), y=r(1,x); q=`${x} - ${y}`; a=x-y; break; }

          /* LEVEL 2: JUNIOR */
          case 'l2_add': { const n1=r(5,25), n2=r(5,25); q=`${n1} + ${n2}`; a=n1+n2; break; }
          case 'l2_sub': { const top=r(15,50), bot=r(5,top-5); q=`${top} - ${bot}`; a=top-bot; break; }
          case 'l2_mul': { 
             const tables=[2,3,5,10]; const t2=tables[r(0,3)]; const m2=r(1,10); 
             q=`${t2} √ó ${m2}`; a=t2*m2; break; 
          }
          case 'l2_place': {
             const v=r(100,999).toString(); const pos=r(0,2); //0=H,1=T,2=U
             // Ensure digits unique enough to not be confusing?
             // Simple version:
             q = `Value of ${v[pos]} in ${v}?`;
             if(pos===0) a=parseInt(v[0])*100;
             else if(pos===1) a=parseInt(v[1])*10;
             else a=parseInt(v[2]);
             break;
          }

          /* LEVEL 3: SENIOR */
          case 'l3_add': { const a1=r(100,500), b1=r(100,400); q=`${a1} + ${b1}`; a=a1+b1; break; }
          case 'l3_sub': { const s1=r(300,900), s2=r(100,s1-50); q=`${s1} - ${s2}`; a=s1-s2; break; }
          case 'l3_mul': { const m3a=r(11,20), m3b=r(2,9); q=`${m3a} √ó ${m3b}`; a=m3a*m3b; break; }
          case 'l3_div': { const d3=r(2,12), ans3=r(2,12); q=`${d3*ans3} √∑ ${d3}`; a=ans3; break; }
          case 'l3_power': { if(Math.random()>0.5){const bp=r(2,12); q=`${bp}¬≤`; a=bp*bp;} else {const bp2=r(1,5); q=`${bp2}¬≥`; a=bp2**3;} break; }
          case 'l3_root': { const rt=r(2,12); q=`‚àö${rt*rt}`; a=rt; break; }
          case 'l3_alg': { const x=r(2,12), add=r(1,20); q=`x + ${add} = ${x+add}`; a=x; break; }

          /* LEVEL 4: HIGH SCHOOL */
          case 'l4_int': { 
             const ia=r(1,10), ib=r(1,10);
             if(Math.random()>0.5){ q=`${ia} - ${ia+ib}`; a=-ib; } // 5 - 8 = -3
             else { q=`-${ia} + ${ib}`; a=ib-ia; } // -2 + 5 = 3
             break; 
          }
          case 'l4_bod': {
             const b1=r(2,5), b2=r(2,5), b3=r(2,5);
             q = `${b1} + ${b2} √ó ${b3}`; a = b1 + (b2*b3);
             break;
          }
          case 'l4_pct': {
             // Simple percents: 10, 20, 25, 50%
             const pcts=[10,20,25,50]; const pc=pcts[r(0,3)];
             let base=0;
             if(pc===10) base=r(1,10)*10; 
             else if(pc===25) base=r(1,10)*4;
             else if(pc===50) base=r(2,20)*2;
             else base=r(1,5)*10; // 20%
             q=`${pc}% of ${base}`; a=(pc/100)*base;
             break;
          }
          case 'l4_alg': {
             // 2x + 3 = 13
             const x=r(2,10), m=r(2,5), c=r(1,10);
             q=`${m}x + ${c} = ${m*x+c}`; a=x;
             break;
          }
        }
        return {q, a};
      }

      function nextQuestion(){
        const {q, a} = generateQ();
        el.qText.textContent = q;
        
        let opts = new Set([a]);
        // Adaptive distraction range based on magnitude of answer
        let range = 5;
        if(Math.abs(a) > 20) range = 10;
        if(Math.abs(a) > 100) range = 30;

        while(opts.size < 4) {
          let v = a + Math.floor(Math.random() * (range*2)) - range; 
          if(v!==a) opts.add(v);
        }
        const arr = Array.from(opts).sort(()=>Math.random()-0.5);
        el.answers.innerHTML = '';
        arr.forEach((val, idx) => {
          const btn = document.createElement('button');
          btn.className = 'answer-btn'; btn.textContent = val; btn.dataset.key = idx+1;
          btn.onclick = (e) => handleAnswer(val, a, btn, e);
          el.answers.appendChild(btn);
        });
      }

      function handleAnswer(val, correct, btn, e){
        if(btn.disabled) return;
        $$('.answer-btn').forEach(b=>b.disabled=true); 
        const rect = btn.getBoundingClientRect();
        const center = { x: rect.left + rect.width/2, y: rect.top };
        if(val === correct){
          btn.classList.add('correct');
          const pts = 10 * S.multiplier; S.score += pts; S.rankScore += 1; S.streak++;
          AudioSys.playCorrect(S.streak); flashScreen('green');
          spawnConfetti(center.x, center.y, '#00d26a'); showFloatingText(center.x, center.y, `+${pts}`, '#00d26a');
          el.mascot.className = 'mascot jump'; setTimeout(()=>el.mascot.className='mascot', 400);
        } else {
          btn.classList.add('wrong'); S.streak = 0;
          AudioSys.playWrong(); flashScreen('red');
          el.mascot.className = 'mascot shake';
          $$('.answer-btn').forEach(b => { if(parseInt(b.textContent)===correct) b.classList.add('correct'); });
          setTimeout(()=>el.mascot.className='mascot', 400);
        }
        setTimeout(() => { if(S.active) nextQuestion(); }, 1000);
      }

      // -- EVENTS --
      document.addEventListener('keydown', (e) => {
        if(!S.active) return;
        const k = parseInt(e.key);
        if(k >= 1 && k <= 4){ const btn = $$('.answer-btn')[k-1]; if(btn) btn.click(); }
      });

      el.avatarSelector = $$('.avatar-option').forEach(opt => {
        opt.onclick = () => {
          $$('.avatar-option').forEach(o=>o.classList.remove('selected'));
          opt.classList.add('selected'); S.avatar = opt.textContent; AudioSys.playTone(600, 'sine', 0.1);
        };
      });

      // Tab Filtering
      el.lvlTabs.forEach(tab => {
        tab.onclick = () => {
            filterMissions(tab.dataset.lvl);
            AudioSys.playTone(400, 'sine', 0.05);
        };
      });

      el.missionCards.forEach(card => {
        card.onclick = () => {
          el.missionCards.forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected'); S.mode = card.dataset.mode; AudioSys.playTone(600, 'sine', 0.1);
        };
      });

      el.timeBtns.forEach(btn => {
        btn.onclick = () => {
          el.timeBtns.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected'); S.timeLimit = parseInt(btn.dataset.time); AudioSys.playTone(600, 'sine', 0.1);
        };
      });

      $('#startBtn').onclick = startCountdown;
      $('#playAgainBtn').onclick = startCountdown;
      
      $('#homeBtn').onclick = () => {
        el.resultModal.classList.remove('show');
        el.startScreen.classList.remove('hidden');
        updateHighScoresDisplay();
      };

      $('#exitBtn').onclick = () => { 
        S.active = false; 
        el.startScreen.classList.remove('hidden'); 
        updateHighScoresDisplay(); 
      };
      
      $('#soundBtn').onclick = () => { S.sound = !S.sound; $('#soundBtn').style.opacity = S.sound ? '1' : '0.3'; };
      $('#themeToggle').onchange = (e) => { document.body.dataset.theme = e.target.checked ? 'light' : 'dark'; };

      // Init
      filterMissions(1);
      updateHighScoresDisplay();
    })();
  </script>
</body>
</html>